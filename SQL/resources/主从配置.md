# MySQL 主从配置
##主从配置的原理

MySQL之间数据复制的基础是二进制日志文件（binary log file）。一台MySQL数据库一旦启用二进制日志后，
其作为master，它的数据库中所有操作都会以“事件”的方式记录在二进制日志中，其他数据库作为slave通
过一个I/O线程与主服务器保持通信，并监控master的二进制日志文件的变化，如果发现master二进制日志文
件发生变化，则会把变化复制到自己的中继日志中，然后slave的一个SQL线程会把相关的“事件”执行到自己
的数据库中，以此实现从数据库和主数据库的一致性，也就实现了主从复制。

### 主配置
修改Master节点mysql的my.cnf
```properties

#添加 service-id 是全局唯一的id。不能重复
server-id=a1
#添加默认备份的数据库   不过不设置就默认为备份全部数据库
binlog-do-db=testdb
#忽略开始binlog日志备份的数据库
binlog-ignore-db=mysql
# 读写模式是0 ， 只读模式是1
read-only=0
#开启binlog备份模式，mysql性能会有1%的损耗
log-bin=mysql-bin
#binlog 日志的格式 ，mysql默认采用，如果从服务器要是链式复制，其他服务器也要复制他，则从服务器也要设置该选项
binlog_format =mixed 
#  超过7天的binlog删除
expire_logs_days =7  

```
查看Master上状态状态 记录master现在binlog的写入位置，当前位置是：mysql-bin.000002 的634位置
```sql
/*!  查看主状态   */
show master status\G;
/**
*************************** 1. row ***************************
File: mysql-bin.000002   现在正在写入的binlog文件名
Position: 634            正在写入位置
Binlog_Do_DB: testdb    写入数据库的名称
Binlog_Ignore_DB: mysql
Executed_Gtid_Set:
1 row in set (0.00 sec)
 */
/*!给ip地址为所有（%表示任何ip）MySQL服务器上的admin(密码为liuy) 授权对该master的复制权限*/
grant replication slave on *.* to 'admin'@'%' IDENTIFIED BY 'liuy'; 

```
### Slave服务器的配置

```properties
#服务器id为2
server-id=2
# 需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可
replicate-do-db =testdb
#不需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可
replicate-ignore-db = mysql-bin
##  链式复制模式A->B->C的时候才使用此设置
#log_slave_updates=1
#默认存储引擎
default-storage-engine = InnoDB
#忽略表大小写 
lower_case_table_names = 1 

```
启动子节点，并查看服务状态。
```sql
# 连接master服务器
change master to master_host='192.168.0.104', 
master_port=3306,
master_user='admin',
master_password='liuy', 
#Master服务器产生的日志文件
master_log_file='master-bin.000002',
#Master的binlog写入位置
master_log_pos=634; 

#启动子节点
start slave;
#停止子节点
stop slave;

# 查看从服务器节点状态  两个YES为正常
show slave status\G
/**************************** 1. row ***************************
Slave_IO_State: Waiting for master to send event
Master_Host: 192.168.1.250
Master_User: liuy
Master_Port: 3306
Connect_Retry: 60
Master_Log_File: mysql-bin.000002
Read_Master_Log_Pos: 634
Relay_Log_File: mysqld-relay-bin.000002
Relay_Log_Pos: 797
Relay_Master_Log_File: mysql-bin.000002
Slave_IO_Running: Yes    #服务器运行正常标识1
Slave_SQL_Running: Yes   #服务器运行正常标识2
Replicate_Do_DB:
Replicate_Ignore_DB:
Replicate_Do_Table:
Replicate_Ignore_Table:
Replicate_Wild_Do_Table:
Replicate_Wild_Ignore_Table:
Last_Errno: 0
Last_Error:
Skip_Counter: 0
Exec_Master_Log_Pos: 634
Relay_Log_Space: 971
Until_Condition: None
Until_Log_File:
Until_Log_Pos: 0
Master_SSL_Allowed: No
Master_SSL_CA_File:
Master_SSL_CA_Path:
Master_SSL_Cert:
Master_SSL_Cipher:
Master_SSL_Key:
Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
Last_IO_Errno: 0
Last_IO_Error:
Last_SQL_Errno: 0
Last_SQL_Error:
Replicate_Ignore_Server_Ids:
Master_Server_Id: 1
Master_UUID: 84b731f2-0767-11e9-9324-000c29498996
Master_Info_File: /var/lib/mysql/master.info
SQL_Delay: 0
SQL_Remaining_Delay: NULL
Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to updat                                                                                                              e it
Master_Retry_Count: 86400
Master_Bind:
Last_IO_Error_Timestamp:
Last_SQL_Error_Timestamp:
Master_SSL_Crl:
Master_SSL_Crlpath:
Retrieved_Gtid_Set:
Executed_Gtid_Set:
Auto_Position: 0
1 row in set (0.00 sec)
*/

#

```